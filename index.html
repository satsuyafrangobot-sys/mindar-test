<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <!-- look-at component -->
  <script
    src="https://cdn.jsdelivr.net/gh/ngokevin/aframe-look-at-component@master/dist/aframe-look-at-component.min.js"></script>
  <style>
    /* === Prevent A-Frame from taking full screen === */
    html,
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      width: 100%;
    }

    /* The container for your AR scene */
    #ar-container {
      width: 99.5%;
      height: 75vh;
      position: relative;
      overflow: hidden;
      /*background: #000;*/
      border-radius: 10px;
    }

    #ar-container video {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      z-index: 1 !important;
      opacity: 1 !important;
      display: block !important;
    }

    /* The WebGL canvas (A-Frame scene) should sit ON TOP */
    #ar-container canvas,
    #ar-container .a-canvas {
      position: absolute !important;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
    }

    .elementor-widget-container {
      overflow: visible !important;
    }
  </style>
</head>

<body>
  <div id="ar-container">
    <a-scene mindar-image="imageTargetSrc: ./data/card.mind; 
          uiScanning: false;
          filterMinCF: 0.0005; 
          filterBeta: 0.01; 
          warmupTolerance: 3;" color-space="sRGB"
      renderer="alpha: true; colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false">
    <!-- <a-scene mindar-image="imageTargetSrc: ./wp-content/uploads/data/card.mind; 
          uiScanning: false;
          filterMinCF: 0.0005; 
          filterBeta: 0.01; 
          warmupTolerance: 3;" color-space="sRGB"
      renderer="alpha: true; colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"> -->
      <a-assets>
        <!-- <img id="card" src="./data/card.png" /> -->
        <!-- <img id="card" src="./wp-content/uploads/data/card.mind" /> -->

        <video id="avatarVideo" src="./videos/video2.webm" loop="true" playsinline webkit-playsinline
          crossorigin="anonymous">
        </video>
        <!-- <video id="avatarVideo" src="./wp-content/uploads/videos/video2.webm" loop="true" playsinline webkit-playsinline
          crossorigin="anonymous">
        </video> -->
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" id="target"
        inertia-smooth="smoothFactor: 0.08; predictionFactor: 0.7; yOnly: true">
        <!-- Video Plane -->
        <a-plane id="videoPlane" position="0 0 0.1" rotation="0 0 0" width="2.5" height="1.38"
          material="shader: flat; src: #avatarVideo; transparent: true; alphaTest: 0.5" billboard>
        </a-plane>
      </a-entity>
    </a-scene>
  </div>

  <script>
    // ======= Inertia (Kalman-like) smoothing filter =======
    AFRAME.registerComponent("inertia-smooth", {
      schema: {
        smoothFactor: { default: 0.15 },
        predictionFactor: { default: 0.9 },
        yOnly: { default: true },
      },
      init() {
        this.prevPos = new THREE.Vector3();
        this.prevVel = new THREE.Vector3();
        this.prevQuat = new THREE.Quaternion();
        this.prevAngVel = new THREE.Vector3();
        this.tmpPos = new THREE.Vector3();
        this.tmpQuat = new THREE.Quaternion();
        this.tmpEuler = new THREE.Euler();
        this.initialized = false;
      },
      tick(time, delta) {
        const parent = this.el.parentEl && this.el.parentEl.object3D;
        if (!parent) return;
        const obj = this.el.object3D;
        const dt = delta / 1000;
        if (dt <= 0) return;

        // Get parent's world transform
        parent.getWorldPosition(this.tmpPos);
        parent.getWorldQuaternion(this.tmpQuat);

        // Y-only rotation
        if (this.data.yOnly) {
          this.tmpEuler.setFromQuaternion(this.tmpQuat, "YXZ");
          this.tmpEuler.x = 0;
          this.tmpEuler.z = 0;
          this.tmpQuat.setFromEuler(this.tmpEuler);
        }

        if (!this.initialized) {
          this.prevPos.copy(this.tmpPos);
          this.prevQuat.copy(this.tmpQuat);
          this.initialized = true;
          return;
        }

        // ---- Position smoothing with velocity prediction ----
        const vel = this.tmpPos.clone().sub(this.prevPos).divideScalar(dt);
        this.prevVel.lerp(vel, this.data.smoothFactor);
        this.prevPos.lerp(this.tmpPos, this.data.smoothFactor);
        const predictedPos = this.prevPos.clone().addScaledVector(this.prevVel, this.data.predictionFactor * dt);
        obj.position.copy(predictedPos);

        // ---- Rotation smoothing ----
        this.prevQuat.slerp(this.tmpQuat, this.data.smoothFactor);
        obj.quaternion.copy(this.prevQuat);
      },
    });

    // ======= Billboard: keep plane facing camera =======
    // Custom component: keeps object facing camera around Y-axis only
    AFRAME.registerComponent("billboard", {
      tick: function () {
        const camera = document.querySelector("[camera]").object3D;
        const obj = this.el.object3D;
        const camPos = new THREE.Vector3();
        camera.getWorldPosition(camPos);
        obj.lookAt(camPos);
      },
    });

    // ======= Video handling =======
    const video = document.querySelector("#avatarVideo");
    const target = document.querySelector("#target");

    // Detect iOS Safari
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    if (isIOS && isSafari) {
      // iOS Safari: use HEVC/alpha video
      video.src = "./videos/video2_1.mp4";
    } else {
      // Other browsers: WebM with alpha
      video.src = "./videos/video2.webm";
    }

    target.addEventListener("targetFound", () => {
      video.play();
    });

    target.addEventListener("targetLost", () => {
      video.pause();
      video.currentTime = 0; // optional: reset video
    });
  </script>
</body>

</html>